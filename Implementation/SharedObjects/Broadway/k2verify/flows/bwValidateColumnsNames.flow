tags: k2verify
stages:
  Flow inputs:
    actors:
      Column!=Null:
        parent: JavaScript
        condition: result
        in:
          script:
            const: columns!=null && columns!=''
          columns:
            external: columns
            schema: string
            mandatory: false
        out:
          result:
            schema: boolean
      SEPERATOR:
        parent: GetLUVariable
        in:
          luName:
            const: K2Verify
          variableName:
            const: K2VERIFY_CONF_SEPARATOR
      CaseSensitive:
        parent: Const
        in:
          value:
            const: null
            external: case_sensitive
            schema: string
        out:
          value:
            schema: string
      ValidationEnv:
        parent: Const
        in:
          value:
            const: null
            external: validation_env
        out:
          value:
            schema: string
  Validation queries:
    actors:
      SRC Validation SQL:
        parent: InnerFlow
        in:
          flowName:
            const: bwGetMetadataValidationSql
          interface:
            external: src_interface
            schema: string
            mandatory: false
            createdBy: flowName
        out:
          sql:
            schema: '#ref'
      TAR Validation SQL:
        parent: InnerFlow
        in:
          flowName:
            const: bwGetMetadataValidationSql
          interface:
            external: tar_interface
            schema: string
            mandatory: false
            createdBy: flowName
        out:
          sql:
            schema: '#ref'
  Case insensitive:
    dependsOn: Validation queries
    actors:
      CaseSensitive=false:
        parent: EqualsIgnoreCase
        condition: result
        in:
          b:
            const: 'false'
            schema: string
          a:
            link: CaseSensitive/value
    split: '--------------------'
  Validate case sensitive col names:
    else: true
    dependsOn: Validation queries
    actors:
      bwValidateCSColumnsNames1:
        parent: InnerFlow
        in:
          flowName:
            const: bwValidateCSColumnsNames
          columns:
            external: columns
            schema: string
            mandatory: false
            createdBy: flowName
          case_sensitive:
            schema: string
            mandatory: false
            createdBy: flowName
          validation_env:
            external: validation_env
            schema: string
            mandatory: false
            createdBy: flowName
          src_interface:
            external: src_interface
            schema: string
            mandatory: false
            createdBy: flowName
          tar_interface:
            external: tar_interface
            schema: string
            mandatory: false
            createdBy: flowName
          src_schema:
            external: src_schema
            schema: string
            mandatory: false
            createdBy: flowName
          src_table:
            external: src_table
            schema: string
            mandatory: false
            createdBy: flowName
          tar_schema:
            external: tar_schema
            schema: string
            mandatory: false
            createdBy: flowName
          tar_table:
            external: tar_table
            schema: string
            mandatory: false
            createdBy: flowName
          column_mapping:
            external: column_mapping
            schema: string
            mandatory: false
            createdBy: flowName
  Src env:
    dependsOn: Case insensitive
    actors:
      SrcEnv:
        parent: JavaScript
        condition: result
        in:
          script:
            const: env=='SRC' || env=='BOTH'
          env:
            link: ValidationEnv/value
            schema: string
            mandatory: false
        out:
          result:
            schema: boolean
      ColumnsFromSourceDB:
        parent: DbCommand
        in:
          interface:
            const: null
            external: src_interface
          sql:
            const: null
            link: SRC Validation SQL/sql/column_ci
          schema:
            external: src_schema
            schema: string
            mandatory: false
            createdBy: sql
          table:
            external: src_table
            schema: string
            mandatory: false
            createdBy: sql
        out:
          result:
            schema: '#ref'
    split: '--------------------'
  Tar env:
    dependsOn: Case insensitive
    actors:
      TarEnv:
        parent: JavaScript
        condition: result
        in:
          script:
            const: env=='TAR' || env=='BOTH'
          env:
            link: ValidationEnv/value
            schema: string
            mandatory: false
        out:
          result:
            schema: boolean
      ColumnsFromTarDB:
        parent: DbCommand
        in:
          interface:
            const: null
            external: tar_interface
          sql:
            const: null
            link: TAR Validation SQL/sql/column_ci
          schema:
            external: tar_schema
            schema: string
            mandatory: false
            createdBy: sql
          table:
            external: tar_table
            schema: string
            mandatory: false
            createdBy: sql
        out:
          result:
            schema: '#ref'
    split: '--------------------'
  Stage 4:
    dependsOn: Validate case sensitive col names
  Src Columns to upper case:
    dependsOn: Src env
    actors:
      toUpperCase:
        parent: Mapper
        in:
          script:
            const: value[0].toUpperCase();
          values:
            link: ColumnsFromSourceDB/result
        out:
          values:
            schema: '#ref'
    split: '--------------------'
  Tar Columns to upper case:
    dependsOn: Tar env
    actors:
      'toUpperCase ':
        parent: Mapper
        in:
          script:
            const: value[0].toUpperCase();
          values:
            link: ColumnsFromTarDB/result
        out:
          values:
            schema: '#ref'
      Split1:
        parent: Split
        in:
          delimiter:
            const: null
            link: SEPERATOR/variableValue
          string:
            external: columns
    split: '--------------------'
  Stage 5:
    dependsOn: Stage 4
  Source cols & mtable cols:
    dependsOn: Src Columns to upper case
    actors:
      ColsFromSrc:
        parent: DeepCopy
        in:
          value:
            link: toUpperCase/values
        out:
          value:
            schema: '#ref'
      ColsFromMtable:
        parent: Split
        in:
          delimiter:
            const: null
            link: SEPERATOR/variableValue
          string:
            external: columns
    split: '--------------------'
  Target cols & mtable cols:
    dependsOn: Tar Columns to upper case
    actors:
      ColsFomTar:
        parent: DeepCopy
        in:
          value:
            link: toUpperCase /values
        out:
          value:
            schema: '#ref'
      MappedCols:
        parent: InnerFlow
        in:
          flowName:
            const: bwGetColsForSelectStmt
          env:
            const: TAR
            schema: string
            mandatory: false
            createdBy: flowName
          column_mapping:
            external: column_mapping
            schema: string
            mandatory: false
            createdBy: flowName
          delim:
            link: SEPERATOR/variableValue
            schema: string
            mandatory: false
            createdBy: flowName
          select_columns:
            link: Split1/strings
            schema: string
            mandatory: false
            createdBy: flowName
          colsFromPII:
            const: 'true'
            schema: string
            mandatory: false
            createdBy: flowName
        out:
          columns_for_select:
            schema: string
          columns:
            schema: '#ref'
    split: '--------------------'
  Stage 8:
    dependsOn: Stage 5
  Find column name in source:
    dependsOn: Source cols & mtable cols
    actors:
      Filter2:
        parent: Filter
        in:
          script:
            const: value==col.toUpperCase()
          col:
            link:
              path: ColsFromMtable/strings
              iterate: Iterate
            schema: string
            mandatory: false
          values:
            link: ColsFromSrc/value
        out:
          values:
            schema: '#ref'
    split: '--------------------'
  Find column name in target:
    dependsOn: Target cols & mtable cols
    actors:
      Filter1:
        parent: Filter
        in:
          script:
            const: value==col.toUpperCase()
          col:
            link:
              path: MappedCols/columns
              iterate: Iterate
            schema: string
            mandatory: false
          values:
            link: ColsFomTar/value
        out:
          values:
            schema: '#ref'
    split: '--------------------'
  Stage 9:
    dependsOn: Stage 8
  Helper copy:
    dependsOn: Find column name in source
    actors:
      DeepCopy1:
        parent: DeepCopy
        in:
          value:
            link: Filter2/values
        out:
          value:
            schema: string
    split: '--------------------'
  'Helper copy ':
    dependsOn: Find column name in target
    actors:
      DeepCopy2:
        parent: DeepCopy
        in:
          value:
            link: Filter1/values
        out:
          value:
            schema: string
    split: '--------------------'
  Stage 10:
    dependsOn: Stage 9
  Assert column found in src:
    last: 1
    dependsOn: Helper copy
    actors:
      assertNotEquals1:
        parent: assertNotEquals
        in:
          unexpected:
            const: [
              ]
            schema: '#ref'
          message:
            const: Column '${column}' doesn't exist in the source table. If it is
              a key column, ensure it is case-sensitive.
          column:
            link:
              path: ColsFromMtable/strings
              iterate: Iterate
            schema: string
            mandatory: false
            createdBy: message
          actual:
            link:
              path: DeepCopy1/value
              iterate: First
    split: '--------------------'
  Assert column found in tar:
    last: 1
    dependsOn: 'Helper copy '
    actors:
      assertNotEquals2:
        parent: assertNotEquals
        in:
          unexpected:
            const: [
              ]
            schema: '#ref'
          message:
            const: Column '${column}' doesn't exist in the target table. If it is
              a key column, ensure it is case-sensitive.
          column:
            link:
              path: MappedCols/columns
              iterate: Iterate
            schema: string
            mandatory: false
            createdBy: message
          actual:
            link:
              path: DeepCopy2/value
              iterate: First
    split: '--------------------'
  Stage 11:
    last: 1
    dependsOn: Stage 10
  Stage 12: {
    }
schemas:
  SRC Validation SQL.out.sql:
    type: object
    properties:
      schema: {
        }
      table: {
        }
      column: {
        }
      column_ci: {
        }
  TAR Validation SQL.out.sql:
    type: object
    properties:
      schema:
        type: string
      table:
        type: string
      column:
        type: string
      column_ci:
        type: string
  ColumnsFromSourceDB.out.result:
    type: array
    items:
      type: object
      properties:
        column_name:
          type: string
  ColumnsFromTarDB.out.result:
    type: array
    items:
      type: object
      properties:
        '1':
          type: integer
  toUpperCase.out.values:
    type: array
    items:
      type: string
  toUpperCase .out.values:
    type: array
    items:
      type: string
  ColsFromSrc.out.value:
    type: array
    items:
      type: string
  ColsFomTar.out.value:
    type: array
    items:
      type: string
  MappedCols.out.columns:
    type: array
    items:
      type: string
  Filter2.out.values:
    type: array
    items:
      type: string
  Filter1.out.values:
    type: array
    items:
      type: string
  assertNotEquals1.in.unexpected:
    type: array
    items: {
      }
  assertNotEquals2.in.unexpected:
    type: array
    items: {
      }
