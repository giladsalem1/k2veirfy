tags: k2verify
stages:
  Stage 1:
    actors:
      Validate SRC Interface:
        parent: InnerFlow
        in:
          flowName:
            const: bwCheckDBType
          interface:
            external: interface
            schema: string
            mandatory: false
            createdBy: flowName
        out:
          type:
            schema: string
  Stage 2:
    actors:
      JavaScript1:
        parent: JavaScript
        in:
          script:
            const:
              userCode: |
                function buildValidationQueries(dbType) {
                    const db = dbType.toLowerCase();

                    let schemaSql, tableSql, columnSql, columnCiSql;

                    // ---------------- POSTGRESQL ----------------
                    if (db === "postgresql (db)") {
                        schemaSql = "SELECT 1 FROM information_schema.schemata WHERE schema_name = '${@schema}'";
                        tableSql  = "SELECT 1 FROM information_schema.tables WHERE table_schema = '${@schema}' AND table_name = '${@table}'";
                        columnSql = "SELECT 1 FROM information_schema.columns WHERE table_schema = '${@schema}' AND table_name = '${@table}' AND column_name = '${@column}'";

                        // Case-insensitive check
                        columnCiSql = "SELECT column_name FROM information_schema.columns WHERE table_schema = '${@schema}' AND table_name = '${@table}' ";
                    }

                    // ---------------- CASSANDRA ----------------
                    else if (db === "cassandra (db)") {
                        schemaSql = "SELECT keyspace_name FROM system_schema.keyspaces WHERE keyspace_name = '${@schema}'";
                        tableSql  = "SELECT table_name FROM system_schema.tables WHERE keyspace_name = '${@schema}' AND table_name = '${@table}'";
                        columnSql = "SELECT column_name FROM system_schema.columns WHERE keyspace_name = '${@schema}' AND table_name = '${@table}' AND column_name = '${@column}'";

                        // Case-insensitive check
                        columnCiSql = "SELECT column_name FROM system_schema.columns WHERE keyspace_name = '${@schema}' AND table_name = '${@table}'";
                    }

                    // ---------------- ORACLE ----------------
                    else if (db === "oracle (db)") {
                        schemaSql = "SELECT 1 FROM all_users WHERE username = UPPER('${@schema}')";
                        tableSql  = "SELECT 1 FROM all_tables WHERE owner = UPPER('${@schema}') AND table_name = UPPER('${@table}')";
                        columnSql = "SELECT 1 FROM all_tab_columns WHERE owner = UPPER('${@schema}') AND table_name = UPPER('${@table}') AND column_name = '${@column}'";

                        // Case-insensitive column
                        // (metadata always uppercased)
                        columnCiSql = "SELECT column_name FROM all_tab_columns WHERE owner = UPPER('${@schema}') AND table_name = UPPER('${@table}') ";
                    }

                    // ---------------- DB2 ----------------
                    else if (db === "db2 (db)") {
                        schemaSql = "SELECT 1 FROM SYSCAT.SCHEMATA WHERE SCHEMANAME = UPPER('${@schema}')";
                        tableSql  = "SELECT 1 FROM SYSCAT.TABLES WHERE TABSCHEMA = UPPER('${@schema}') AND TABNAME = UPPER('${@table}')";
                        columnSql = "SELECT 1 FROM SYSCAT.COLUMNS WHERE TABSCHEMA = UPPER('${@schema}') AND TABNAME = UPPER('${@table}') AND COLNAME = '${@column}'";

                        // Case-insensitive column
                        columnCiSql = "SELECT COLNAME FROM SYSCAT.COLUMNS WHERE TABSCHEMA = UPPER('${@schema}') AND TABNAME = UPPER('${@table}')";
                    }

                    return {
                        "schema": schemaSql,
                        "table": tableSql,
                        "column": columnSql,
                        "column_ci": columnCiSql   // NEW VALIDATION TYPE
                    };
                }

                var result = buildValidationQueries(dbType);
                result;
              script: |-
                function buildValidationQueries(dbType) {
                  var db = dbType.toLowerCase();
                  var schemaSql, tableSql, columnSql, columnCiSql; // ---------------- POSTGRESQL ----------------

                  if (db === "postgresql (db)") {
                    schemaSql = "SELECT 1 FROM information_schema.schemata WHERE schema_name = '${@schema}'";
                    tableSql = "SELECT 1 FROM information_schema.tables WHERE table_schema = '${@schema}' AND table_name = '${@table}'";
                    columnSql = "SELECT 1 FROM information_schema.columns WHERE table_schema = '${@schema}' AND table_name = '${@table}' AND column_name = '${@column}'"; // Case-insensitive check

                    columnCiSql = "SELECT column_name FROM information_schema.columns WHERE table_schema = '${@schema}' AND table_name = '${@table}' ";
                  } // ---------------- CASSANDRA ----------------
                  else if (db === "cassandra (db)") {
                      schemaSql = "SELECT keyspace_name FROM system_schema.keyspaces WHERE keyspace_name = '${@schema}'";
                      tableSql = "SELECT table_name FROM system_schema.tables WHERE keyspace_name = '${@schema}' AND table_name = '${@table}'";
                      columnSql = "SELECT column_name FROM system_schema.columns WHERE keyspace_name = '${@schema}' AND table_name = '${@table}' AND column_name = '${@column}'"; // Case-insensitive check

                      columnCiSql = "SELECT column_name FROM system_schema.columns WHERE keyspace_name = '${@schema}' AND table_name = '${@table}'";
                    } // ---------------- ORACLE ----------------
                    else if (db === "oracle (db)") {
                        schemaSql = "SELECT 1 FROM all_users WHERE username = UPPER('${@schema}')";
                        tableSql = "SELECT 1 FROM all_tables WHERE owner = UPPER('${@schema}') AND table_name = UPPER('${@table}')";
                        columnSql = "SELECT 1 FROM all_tab_columns WHERE owner = UPPER('${@schema}') AND table_name = UPPER('${@table}') AND column_name = '${@column}'"; // Case-insensitive column
                        // (metadata always uppercased)

                        columnCiSql = "SELECT column_name FROM all_tab_columns WHERE owner = UPPER('${@schema}') AND table_name = UPPER('${@table}') ";
                      } // ---------------- DB2 ----------------
                      else if (db === "db2 (db)") {
                          schemaSql = "SELECT 1 FROM SYSCAT.SCHEMATA WHERE SCHEMANAME = UPPER('${@schema}')";
                          tableSql = "SELECT 1 FROM SYSCAT.TABLES WHERE TABSCHEMA = UPPER('${@schema}') AND TABNAME = UPPER('${@table}')";
                          columnSql = "SELECT 1 FROM SYSCAT.COLUMNS WHERE TABSCHEMA = UPPER('${@schema}') AND TABNAME = UPPER('${@table}') AND COLNAME = '${@column}'"; // Case-insensitive column

                          columnCiSql = "SELECT COLNAME FROM SYSCAT.COLUMNS WHERE TABSCHEMA = UPPER('${@schema}') AND TABNAME = UPPER('${@table}')";
                        }

                  return {
                    "schema": schemaSql,
                    "table": tableSql,
                    "column": columnSql,
                    "column_ci": columnCiSql // NEW VALIDATION TYPE

                  };
                }

                var result = buildValidationQueries(dbType);
                result;
          dbType:
            link: Validate SRC Interface/type
            schema: string
            mandatory: false
        out:
          result:
            external: sql
            schema: string
  Stage 3: {
    }
