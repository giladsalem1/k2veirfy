tags: d2d,d2dv2,D2D,k2verify
stages:
  Check record emoty:
    transactional: true
    actors:
      SrcRecord=[]:
        parent: Equals
        in:
          b:
            const: [
              ]
            schema: '#ref'
          a:
            external: src_row
      SrcRecord=[{}]:
        parent: Equals
        in:
          b:
            const:
            - {
              }
            schema: '#ref'
          a:
            external: src_row
      TarRecord=[]:
        parent: Equals
        in:
          b:
            const: [
              ]
            schema: '#ref'
          a:
            external: tar_row
      TarRecord=[{}]:
        parent: Equals
        in:
          b:
            const:
            - {
              }
            schema: '#ref'
          a:
            external: tar_row
  Src record doesn't exist:
    transactional: true
    dependsOn: Check record emoty
    actors:
      SrcEmpty:
        parent: Or
        condition: result
        in:
          a:
            link: SrcRecord=[]/result
          b:
            link: SrcRecord=[{}]/result
      ReportDetailsMap1:
        parent: MapCreate
        in:
          EXECUTION_ID:
            external: execution_id
            schema: string
            mandatory: false
          CUSTOMIZED_KEY:
            external: customized_key
            schema: string
            mandatory: false
          TARGET_COLUMN_VALUE:
            external: target_column_value
            schema: '#ref'
            mandatory: false
          MATCH_RESULT:
            const: Target Key Not Found In Source
            schema: string
            mandatory: false
        out:
          map:
            schema: '#ref'
    split: '--------------------'
  Tar record doesn't exist:
    transactional: true
    dependsOn: Check record emoty
    actors:
      TAREmpty:
        parent: Or
        condition: result
        in:
          a:
            link: TarRecord=[]/result
          b:
            link: TarRecord=[{}]/result
      ReportDetailsMap2:
        parent: MapCreate
        in:
          EXECUTION_ID:
            external: execution_id
            schema: string
            mandatory: false
          CUSTOMIZED_KEY:
            external: customized_key
            schema: string
            mandatory: false
          SOURCE_COLUMN_VALUE:
            external: source_column_value
            schema: '#ref'
            mandatory: false
          MATCH_RESULT:
            const: Source Key Not Found In Target
            schema: string
            mandatory: false
        out:
          map:
            schema: '#ref'
    split: '--------------------'
  Stage 2:
    else: true
    transactional: true
    dependsOn: Check record emoty
  Src/Tar Empty:
    transactional: true
    actors:
      Or1:
        parent: Or
        in:
          a:
            link: SrcEmpty/result
          b:
            link: TAREmpty/result
        out:
          result:
            external: keyNotFound
  Report key is missing:
    transactional: true
    actors:
      =true:
        parent: Equals
        condition: result
        in:
          b:
            const: true
            schema: boolean
          a:
            link: Or1/result
      UpdateMissingInLUDB:
        parent: DbLoad
        in:
          interface:
            const: fabric
          schema:
            const: null
            external: schema
          table:
            const: null
            external: table
          fields:
            const:
            - EXECUTION_ID
            - IID
            - SOURCE_TABLE_NAME
            - TARGET_TABLE_NAME
            - CUSTOMIZED_KEY
            - COLUMN_NAME
            - MATCH_RESULT
            - TARGET_VALUE_SECURED
            - SOURCE_COLUMN_VALUE
            - TARGET_COLUMN_VALUE
            - SOURCE_COLUMN_VALUE_TRANS
            - TARGET_COLUMN_VALUE_TRANS
          keys:
            const:
            - EXECUTION_ID
            - IID
            - SOURCE_TABLE_NAME
            - TARGET_TABLE_NAME
            - CUSTOMIZED_KEY
            - COLUMN_NAME
          EXECUTION_ID:
            schema: string
          IID:
            const: '0'
            schema: string
          SOURCE_TABLE_NAME:
            external: source_table_name
            schema: string
          TARGET_TABLE_NAME:
            external: target_table_name
            schema: string
          CUSTOMIZED_KEY:
            schema: string
          COLUMN_NAME:
            external: key_columns
            schema: string
          MATCH_RESULT:
            schema: string
          SOURCE_COLUMN_VALUE:
            schema: string
          TARGET_COLUMN_VALUE:
            schema: string
          SOURCE_COLUMN_VALUE_TRANS:
            schema: string
          TARGET_COLUMN_VALUE_TRANS:
            schema: string
          TARGET_VALUE_SECURED:
            const: 'true'
            schema: string
            mandatory: false
          params:
            link:
            - ReportDetailsMap1/map
            - ReportDetailsMap2/map
      UpdateMissingInDB:
        parent: DbLoad
        in:
          interface:
            const: null
            external: operational_interface
          schema:
            const: null
            external: operational_schema
          table:
            const: null
            external: field_summary_table_name
          fields:
            const:
            - EXECUTION_ID
            - IID
            - SOURCE_TABLE_NAME
            - TARGET_TABLE_NAME
            - CUSTOMIZED_KEY
            - COLUMN_NAME
            - MATCH_RESULT
            - TARGET_VALUE_SECURED
            - SOURCE_COLUMN_VALUE
            - TARGET_COLUMN_VALUE
            - SOURCE_COLUMN_VALUE_TRANS
            - TARGET_COLUMN_VALUE_TRANS
          keys:
            const:
            - EXECUTION_ID
            - IID
            - SOURCE_TABLE_NAME
            - TARGET_TABLE_NAME
            - CUSTOMIZED_KEY
            - COLUMN_NAME
          EXECUTION_ID:
            schema: string
          IID:
            const: '0'
            schema: string
          SOURCE_TABLE_NAME:
            external: source_table_name
            schema: string
          TARGET_TABLE_NAME:
            external: target_table_name
            schema: string
          CUSTOMIZED_KEY:
            schema: string
          COLUMN_NAME:
            external: key_columns
            schema: string
          MATCH_RESULT:
            schema: string
          SOURCE_COLUMN_VALUE:
            schema: string
          TARGET_COLUMN_VALUE:
            schema: string
          SOURCE_COLUMN_VALUE_TRANS:
            schema: string
          TARGET_COLUMN_VALUE_TRANS:
            schema: string
          TARGET_VALUE_SECURED:
            schema: string
            mandatory: false
          params:
            link:
            - ReportDetailsMap1/map
            - ReportDetailsMap2/map
schemas:
  SrcRecord=[].in.b:
    type: array
    items: {
      }
  SrcRecord=[{}].in.b:
    type: array
    items: {
      }
  TarRecord=[].in.b:
    type: array
    items: {
      }
  TarRecord=[{}].in.b:
    type: array
    items: {
      }
  ReportDetailsMap1.in.TARGET_COLUMN_VALUE:
    type: array
    items: {
      }
  ReportDetailsMap1.out.map:
    type: object
    properties:
      EXECUTION_ID:
        type: string
      CUSTOMIZED_KEY: {
        }
      TARGET_COLUMN_VALUE:
        type: string
      MATCH_RESULT:
        type: string
  ReportDetailsMap2.in.SOURCE_COLUMN_VALUE:
    type: array
    items: {
      }
  ReportDetailsMap2.out.map:
    type: object
    properties:
      EXECUTION_ID: {
        }
      CUSTOMIZED_KEY: {
        }
      SOURCE_COLUMN_VALUE: {
        }
