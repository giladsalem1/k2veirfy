tags: k2verify
stages:
  Stage 1:
    actors:
      K2VERIFY_OPERATIONAL_INTERFACE:
        parent: FabricSetRead
        in:
          key:
            const: K2VERIFY_OPERATIONAL_INTERFACE
      K2VERIFY_OPERATIONAL_INTERFACE1:
        parent: FabricSetRead
        in:
          key:
            const: K2VERIFY_OPERATIONAL_SCHEMA
      Conditions:
        parent: Const
        in:
          value:
            const: null
            external: selected_metrics
            schema: string
        out:
          value:
            schema: string
  Stage 2:
    actors:
      Split1:
        parent: Split
        in:
          string:
            link: Conditions/value
  Stage 4:
    actors:
      JavaScript1:
        parent: JavaScript
        in:
          script:
            const:
              userCode: |
                let queryParts = [];

                const baseQuery = `select * from \${@schema_name}.k2verify_field_summary where execution_id = \${execution_id} and source_table_name = \${source_table_name} and `;

                // records_only_in_source
                if (conditions.indexOf("records_only_in_source") >= 0) {
                  queryParts.push(
                    baseQuery + `lower(match_result) = 'source key not found in target'`
                  );
                }

                // records_only_in_target
                if (conditions.indexOf("records_only_in_target") >= 0) {
                  queryParts.push(
                    baseQuery + `lower(match_result) = 'target key not found in source'`
                  );
                }

                // mismatched_records
                if (conditions.indexOf("mismatched_records") >= 0) {
                  queryParts.push(
                    baseQuery + `lower(match_result) = 'not passed'`
                  );
                }

                const finalQuery = queryParts.join(" union ");

                finalQuery;
              script: |-
                var queryParts = [];
                var baseQuery = "select * from ${@schema_name}.k2verify_field_summary where execution_id = ${execution_id} and source_table_name = ${source_table_name} and "; // records_only_in_source

                if (conditions.indexOf("records_only_in_source") >= 0) {
                  queryParts.push(baseQuery + "lower(match_result) = 'source key not found in target'");
                } // records_only_in_target


                if (conditions.indexOf("records_only_in_target") >= 0) {
                  queryParts.push(baseQuery + "lower(match_result) = 'target key not found in source'");
                } // mismatched_records


                if (conditions.indexOf("mismatched_records") >= 0) {
                  queryParts.push(baseQuery + "lower(match_result) = 'not passed'");
                }

                var finalQuery = queryParts.join(" union ");
                finalQuery;
          conditions:
            link: Split1/strings
            schema: '#ref'
            mandatory: false
        out:
          result:
            schema: string
  Stage 3:
    actors:
      DbCommand1:
        parent: DbCommand
        in:
          interface:
            const: null
            link: K2VERIFY_OPERATIONAL_INTERFACE/result
          sql:
            const: null
            link: JavaScript1/result
          schema_name:
            link: K2VERIFY_OPERATIONAL_INTERFACE1/result
            schema: string
            mandatory: false
            createdBy: sql
          source_table_name:
            external: source_table_name
            schema: string
            mandatory: false
            createdBy: sql
          execution_id:
            external: execution_id
            schema: string
            mandatory: false
            createdBy: sql
        out:
          result:
            external: result
            schema: '#ref'
schemas:
  JavaScript1.in.conditions:
    type: array
    items:
      type: string
  DbCommand1.out.result:
    type: array
    items:
      type: object
      properties:
        column_name:
          type: string
        total_failed:
          type: integer
