stages:
  Stage 1:
    actors:
      Const1:
        parent: Const
        in:
          value:
            const: k2verify
            schema: string
        out:
          value:
            schema: string
  Stage 2:
    actors:
      DbCommand3:
        parent: DbCommand
        in:
          interface:
            const: POSTGRESQL_ADMIN
          sql:
            const: drop schema if exists k2verify cascade
      DbCommand2:
        parent: DbCommand
        in:
          interface:
            const: POSTGRESQL_ADMIN
          sql:
            const: |
              CREATE SCHEMA IF NOT EXISTS ${@schema};

              CREATE SEQUENCE IF NOT EXISTS ${@schema}.tasks_task_id_seq
                  INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1;

              CREATE SEQUENCE IF NOT EXISTS ${@schema}.task_execution_id_seq
                  INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1;

              CREATE TABLE IF NOT EXISTS ${@schema}.tasks
              (
                  task_id            bigint NOT NULL DEFAULT nextval('${@schema}.tasks_task_id_seq'::regclass),
                  task_title         text   NOT NULL,
                  task_description   text,
                  task_status        text   NOT NULL DEFAULT 'Active',
                  properties         text,
                  source_interface   text,
                  target_interface   text,
                  created_by         text,
                  created_at         timestamp without time zone NOT NULL DEFAULT now(),
                  updated_by         text,
                  updated_at         timestamp without time zone,
                  CONSTRAINT tasks_pkey PRIMARY KEY (task_id)
              );

              CREATE UNIQUE INDEX IF NOT EXISTS tasks_active_name_ux
                  ON ${@schema}.tasks (task_title)
                  WHERE task_status = 'Active';

              CREATE TABLE IF NOT EXISTS ${@schema}.task_execution
              (
                  execution_id       bigint NOT NULL DEFAULT nextval('${@schema}.task_execution_id_seq'::regclass),
                  task_id            bigint NOT NULL,
                  execution_status   text,
                  start_time         timestamp without time zone,
                  started_by         text,
                  end_time           timestamp without time zone,
                  CONSTRAINT task_execution_pk PRIMARY KEY (execution_id, task_id),
                  CONSTRAINT task_execution_id_ux UNIQUE (execution_id),
                  CONSTRAINT task_execution_task_fk FOREIGN KEY (task_id)
                      REFERENCES ${@schema}.tasks (task_id)
                      ON UPDATE CASCADE ON DELETE CASCADE
              );

              CREATE TABLE IF NOT EXISTS ${@schema}.task_execution_tables
              (
                  task_id            bigint NOT NULL,
                  execution_id       bigint NOT NULL,
                  table_name         text   NOT NULL,
                  batch_id           bigint NOT NULL,
                  status             text,
                  start_time         timestamp without time zone,
                  end_time           timestamp without time zone,

                  CONSTRAINT task_execution_tables_fk
                      FOREIGN KEY (execution_id, task_id)
                      REFERENCES ${@schema}.task_execution (execution_id, task_id)
                      ON UPDATE CASCADE ON DELETE CASCADE,

                  CONSTRAINT task_execution_tables_pk PRIMARY KEY (task_id, execution_id, table_name),
                  CONSTRAINT task_execution_tables_ux UNIQUE (task_id, execution_id, table_name, batch_id)
              );

              CREATE TABLE IF NOT EXISTS ${@schema}.task_execution_buckets
              (
                  task_id           bigint NOT NULL,
                  execution_id      bigint NOT NULL,
                  table_name        text   NOT NULL,
                  bucket_id         bigint NOT NULL,
                  status            text,
                  total_records     numeric(20,0),
                  processed_records numeric(20,0),
                  failed_records    numeric(20,0),
                  start_time        timestamp without time zone,
                  end_time          timestamp without time zone,
                  error_info        text,
                  CONSTRAINT task_execution_buckets_pk
                      PRIMARY KEY (task_id, execution_id, table_name, bucket_id),

                  CONSTRAINT task_exec_buckets_fk FOREIGN KEY (task_id, execution_id, table_name)
                      REFERENCES ${@schema}.task_execution_tables (task_id, execution_id, table_name)
                      ON UPDATE CASCADE ON DELETE CASCADE
              );
          schema:
            link: Const1/value
            schema: string
            mandatory: false
            createdBy: sql
