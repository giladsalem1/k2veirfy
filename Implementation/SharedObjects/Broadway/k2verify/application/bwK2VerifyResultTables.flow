tags: k2verify
stages:
  Stage 1:
    actors:
      K2VERIFY_OPERATIONAL_INTERFACE:
        parent: FabricSetRead
        in:
          key:
            const: K2VERIFY_OPERATIONAL_INTERFACE
      K2VERIFY_OPERATIONAL_INTERFACE1:
        parent: FabricSetRead
        in:
          key:
            const: K2VERIFY_OPERATIONAL_SCHEMA
  Stage 2:
    actors:
      DbCommand1:
        parent: DbCommand
        in:
          interface:
            const: null
            link: K2VERIFY_OPERATIONAL_INTERFACE/result
          sql:
            const: |
              WITH table_stats AS (
                SELECT
                  kts.execution_id,
                  kts.source_table_name,
                  kts.target_table_name,
                  COALESCE(SUM(kts.number_of_records_match), 0)              AS records_match,
                  COALESCE(SUM(kts.number_of_records_mismatch), 0)           AS records_mismatch,
                  COALESCE(SUM(kts.number_of_records_only_in_source), 0)     AS records_only_in_source,
                  COALESCE(SUM(kts.number_of_records_only_in_target), 0)     AS records_only_in_target,
                  MAX(kts.match_result)                                      AS match_result
                FROM ${@schema}.k2verify_table_summary kts
                WHERE kts.execution_id = ${execution_id}
                GROUP BY
                  kts.execution_id,
                  kts.source_table_name,
                  kts.target_table_name
              ),

              field_stats AS (
                SELECT
                  krs.execution_id,
                  krs.source_table_name,
                  krs.target_table_name,
                  COALESCE(SUM(krs.number_of_fields_match), 0)              AS fields_match,
                  COALESCE(SUM(krs.number_of_fields_mismatch), 0)           AS fields_mismatch,
                  COALESCE(SUM(krs.number_of_fields_only_in_source), 0)     AS fields_only_in_source,
                  COALESCE(SUM(krs.number_of_fields_only_in_target), 0)     AS fields_only_in_target
                FROM ${@schema}.k2verify_record_summary krs
                WHERE krs.execution_id = ${execution_id}
                GROUP BY
                  krs.execution_id,
                  krs.source_table_name,
                  krs.target_table_name
              )

              SELECT
                tet.task_id,
                tet.execution_id,
                ts.source_table_name,
                ts.target_table_name,
                ts.match_result                                   AS result,
                tet.start_time,
                tet.end_time,

                (ts.records_match
                 + ts.records_mismatch
                 + ts.records_only_in_source
                 + ts.records_only_in_target)                AS total_records,

                CASE WHEN (ts.records_match
                           + ts.records_mismatch
                           + ts.records_only_in_source
                           + ts.records_only_in_target) > 0
                     THEN ROUND(
                       ts.records_match::numeric * 100.0 /
                       (ts.records_match
                        + ts.records_mismatch
                        + ts.records_only_in_source
                        + ts.records_only_in_target
                      ),
                       2)
                     ELSE NULL
                END                                               AS records_passed_pct,

                ts.records_only_in_source,
                ts.records_only_in_target,
                ts.records_mismatch                               AS mismatched_records,

                /* ---------- FIELD METRICS ---------- */
                (fs.fields_match
                 + fs.fields_mismatch
                 + fs.fields_only_in_source
                 + fs.fields_only_in_target)                 AS total_fields,

                CASE WHEN (fs.fields_match
                           + fs.fields_mismatch
                           + fs.fields_only_in_source
                           + fs.fields_only_in_target) > 0
                     THEN ROUND(
                       fs.fields_match::numeric * 100.0 /
                       (fs.fields_match
                        + fs.fields_mismatch
                        + fs.fields_only_in_source
                        + fs.fields_only_in_target),
                       2)
                     ELSE NULL
                END                                               AS fields_passed_pct

              FROM table_stats ts
              LEFT JOIN field_stats fs
                ON fs.execution_id       = ts.execution_id
               AND fs.source_table_name  = ts.source_table_name
               AND fs.target_table_name  = ts.target_table_name
              LEFT JOIN ${@schema}.task_execution_tables tet
                ON tet.execution_id::text = ts.execution_id
               AND tet.table_name         = ts.source_table_name

              ORDER BY ts.source_table_name, ts.target_table_name;
          schema:
            link: K2VERIFY_OPERATIONAL_INTERFACE1/result
            schema: string
            mandatory: false
            createdBy: sql
          execution_id:
            external: execution_id
            schema: string
            mandatory: false
            createdBy: sql
        out:
          result:
            external: result
            schema: '#ref'
schemas:
  DbCommand1.out.result:
    type: array
    items:
      type: object
      properties:
        task_id:
          type: integer
        execution_id:
          type: integer
        source_table_name:
          type: string
        target_table_name:
          type: string
        result:
          type: string
        start_time:
          type: date
        end_time:
          type: date
        total_records:
          type: integer
        records_passed_pct:
          type: integer
        records_only_in_source:
          type: integer
        records_only_in_target:
          type: integer
        mismatched_records:
          type: integer
        total_fields:
          type: integer
        fields_passed_pct:
          type: integer
